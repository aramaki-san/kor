dist: trusty
sudo: required

env:
  global:
    - HEADLESS=true

addons:
  chrome: stable

services:
  - mysql
  - elasticsearch

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install libav-tools imagemagick
  - curl -O https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.4.6/elasticsearch-2.4.6.deb
  - sudo dpkg -i --force-confnew elasticsearch-2.4.6.deb
  - sudo service elasticsearch restart
  - wget https://chromedriver.storage.googleapis.com/2.44/chromedriver_linux64.zip
  - unzip chromedriver_linux64.zip
  - sudo ln -sfn $(pwd)/chromedriver /usr/local/bin/chromedriver
  - nvm install v6.13.0
  - nvm alias default v6.13.0

install:
  - npm install
  - gem install bundler:1.17.3
  - bundle install --jobs=3 --retry=3 --deployment
  - npm run build

script:
  - mysql -e 'CREATE DATABASE kor_test;'
  - cp deploy/database.travis.yml config/database.yml
  - bundle exec rake db:test:load
  - bundle exec rspec spec/ --tag "~travis:false" --format=documentation
  - bundle exec cucumber --retry 3 --format=pretty --tags "~@notravis" features/
  